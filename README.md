# Проектирование высоконагруженной системы: Яндекс Афиша

## 1. Тема и целевая аудитория

**Тип сервиса**
Агрегатор мероприятий с системой рекомендаций и онлайн-покупкой билетов (B2C SaaS).

**Аналоги**
- Timepad
- Kassir.ru  
- Яндекс Афиша (оригинал)

**Функционал MVP**
- Поиск и фильтрация мероприятий по категориям, дате, локации
- Покупка билетов онлайн
- Личный кабинет организатора для добавления мероприятий
- Комментарии и оценки мероприятий
- Интеграция с Яндекс.Картами для отображения локаций

**Продуктовые решения**
- Микросервисная архитектура (Поиск, Рекомендации, Билеты, Пользователи, Мероприятия)
- Активное кеширование данных мероприятий и билетов "на горячих" событиях
- Асинхронная обработка платежей и выдачи билетов
- ML-модели для рекомендаций на основе предпочтений и поведения пользователей

**Целевая аудитория**

| Параметр | Значение | Источник |
|----------|----------|----------|
| MAU | 8,000,000 | [SimilarWeb] + данные экосистемы Яндекс |
| DAU | 1,600,000 | 20% от MAU |
| География | 85% - Россия, 10% - СНГ, 5% - другие страны | [SimilarWeb] |
| Основная аудитория | 18-45 лет, городские жители | Рыночные исследования |

## 2. Расчет нагрузки

**Продуктовые метрики**

| Метрика | Значение | Источник / Обоснование |
|---------|----------|------------------------|
| Среднее количество сессий на пользователя в день | 1.2 | Оценка: планирование мероприятий 2-3 раза в неделю |
| Средняя длительность сессии | 8 минут | Аналоги: SimilarWeb (Timepad) |
| Количество просмотров мероприятий на сессию | 12 | Оценка: просмотр 2-3 страниц результатов + детализация |
| Процент пользователей, покупающих билеты | 5% | Отраслевая статистика для event-аггрегаторов |
| Среднее количество покупок на платящего пользователя в месяц | 1.5 | Оценка |
| Средний размер JSON-ответа мероприятия | 15 КБ | Основные данные без статики |

**Технические метрики**

#### Объем хранилища

| Тип данных | Кол-во объектов | Средний размер | Общий объем |
|------------|----------------|----------------|-------------|
| Профили пользователей | 8,000,000 | 5 КБ | 40 ГБ |
| Мероприятия (активные + архив) | 2,000,000 | 50 КБ | 100 ГБ |
| Изображения мероприятий | 10,000,000 | 500 КБ | 5 ТБ |
| Отзывы и комментарии | 20,000,000 | 2 КБ | 40 ГБ |
| Билеты (история за 2 года) | 19,200,000 | 10 КБ | 192 ГБ |
| **ИТОГО** | **—** | **—** | **~5.4 ТБ** |

*Расчет билетов:* 1,600,000 DAU × 5% × (1.5 покупок/мес / 30 дней) × 730 дней = 19,200,000 билетов

#### Сетевой трафик

| Тип трафика | Среднее значение (ГБ/день) | Пиковое значение (Гбит/с) |
|-------------|----------------------------|---------------------------|
| Просмотр мероприятий (Входящий) | 345.6 ГБ/день | **32 Гбит/с** |
| Поисковые запросы (Входящий) | 3.7 ГБ/день | 0.34 Гбит/с |
| Покупка билетов (Входящий) | 1.1 ГБ/день | 0.1 Гбит/с |
| Загрузка изображений (Исходящий, CDN) | 24 ГБ/день | 2.2 Гбит/с |
| **ИТОГО исходящий трафик (CDN)** | **~24 ГБ/день** | **~2.2 Гбит/с** |
| **ИТОГО входящий трафик** | **~350.4 ГБ/день** | **~32.4 Гбит/с (пиковое)** |

*Расчет просмотров:*
- Запросов на просмотр в день: 1,600,000 DAU × 1.2 сессии × 12 просмотров = 23,040,000 запросов
- Трафик: 23,040,000 × 15 КБ / 1024 / 1024 = **330 ГБ/день** (округлим до 345.6)

#### RPS (Requests Per Second)

| Тип запроса | Средний RPS | Пиковый RPS (x5) |
|-------------|-------------|------------------|
| GET /events/search (поиск мероприятий) | 44.4 | 222 |
| GET /events/{id} (просмотр мероприятия) | 267 | 1335 |
| POST /tickets/purchase (покупка билета) | 1.9 | 9.5 |
| GET /recommendations (персональные рекомендации) | 44.4 | 222 |
| POST /events (добавление мероприятия) | 0.9 | 4.5 |
| **ИТОГО** | **~358.6 RPS** | **~1793 RPS** |

**Детализация расчетов**

- **DAU:** 1,600,000
- **Просмотр мероприятий (GET /events/{id}):**
  - Запросов в день: 1,600,000 × 1.2 сессии × 12 просмотров/сессию = 23,040,000
  - Средний RPS: 23,040,000 / 86400 сек = **266.7 RPS** (округлим до 267)

- **Поиск и рекомендации (GET /events/search, GET /recommendations):**
  - Запросов в день: 1,600,000 × 1.2 сессии × 2 запроса/сессию = 3,840,000 (на каждый тип)
  - Средний RPS: 3,840,000 / 86400 сек = **44.4 RPS** (на каждый)

- **Покупка билетов (POST /tickets/purchase):**
  - Покупок в день: 1,600,000 × 5% = 80,000
  - Запросов на покупку: 80,000 × 2 = 160,000 (корзина + подтверждение)
  - Средний RPS: 160,000 / 86400 = **1.85 RPS** (округлим до 1.9)

## 3. Глобальная балансировка нагрузки

#### 3.1. Функциональное разбиение по доменам

- **`api.afisha.ru`** (основное API): Пользователи, Мероприятия, Поиск, Комментарии
- **`pay.afisha.ru`** (платежный шлюз): Обработка платежей, выпуск билетов
- **`cdn.afisha.ru`** (контентная сеть): Обслуживание изображений мероприятий, статических assets

#### 3.2. Обоснование расположения ДЦ

**Главная задача:** Обеспечить низкую задержку при поиске мероприятий и покупке билетов, так как это напрямую влияет на конверсию и удовлетворенность пользователей.

**Распределение аудитории и расположение ДЦ:**
- **85% трафика (Россия):** Основная аудитория
    - **ДЦ-1 (Москва):** Обслуживает Центральный регион
    - **ДЦ-2 (Санкт-Петербург):** Обслуживает Северо-Запад и часть Европы
    - **ДЦ-3 (Екатеринбург):** Обслуживает Уральский регион и часть Сибири
- **10% трафика (СНГ):**
    - **ДЦ-4 (Казахстан, Алматы):** Обслуживает Среднюю Азию

#### 3.3. Схема DNS балансировки

Используем **Latency-based (GeoDNS) Routing**
- Пользователь запрашивает `api.afisha.ru`
- DNS-провайдер определяет его местоположение и возвращает IP-адрес того ДЦ, который имеет наименьшую сетевую задержку
- Например, пользователь из Новосибирска будет направлен в ДЦ-3 (Екатеринбург)

#### 3.4. Схема Anycast балансировки

**Anycast** идеально подходит для `cdn.afisha.ru` и `pay.afisha.ru`
- **Для CDN:** Один IP-адрес анонсируется всеми ДЦ. Пользователь всегда попадает на ближайший узел
- **Для платежного шлюза:** Anycast обеспечивает отказоустойчивость. Если один ДЦ недоступен, трафик автоматически перенаправляется

#### 3.5. Механизм регулировки трафика между ДЦ

- **Балансировка чтения:** Поисковые запросы и запросы на просмотр мероприятий обрабатываются ближайшим ДЦ
- **Балансировка записи:** Запросы на создание мероприятий и покупку билетов перенаправляются в основной ДЦ (Москва) для консистентности
- **Active-Active:** Все ДЦ активно обрабатывают запросы

## 4. Локальная балансировка нагрузки

#### 4.1. Схема балансировки нагрузки

Используем многоуровневую схему для отказоустойчивости и эффективного распределения нагрузки

**Уровень 1:** L4 Load Balancer (HAProxy) - TCP-балансировка, SSL Termination  
*(Схема резервирования: Active/Active)*  
**Уровень 2:** L7 Load Balancer (Nginx Ingress) - HTTP-маршрутизация, кеширование  
*(Схема резервирования: N+1)*  
**Уровень 3:** Kubernetes Service (kube-proxy) - Внутрикластерная балансировка  
**Уровень 4:** Pods (микросервисы) - Поиск, Билеты, Пользователи, Рекомендации...

```
Интернет → L4 LB → L7 LB → kube-proxy → Pods
```


**Формула резервирования: N+1**
- На каждом уровне развертывается на один узел больше, чем требуется для обработки пиковой нагрузки

#### 4.2. Расчёт количества балансировщиков

**Исходные данные:**
- **Пиковый RPS:** ~1793 RPS
- **Пиковый трафик (входящий):** ~32.4 Гбит/с

**Ограничивающие факторы для L7-балансировщиков (Nginx):**
1. **SSL Termination:** ~10,000 CPS на 24 CPU
2. **Пропускная способность сети:** 10 Гбит/с на сетевой интерфейс

**Расчет по пропускной способности сети:**
- Пиковый входящий трафик: ~32.4 Гбит/с
- Пропускная способность одного балансировщика: 10 Гбит/с
- **Необходимое количество для обработки трафика:** 32.4 / 10 = 3.24 → **4 балансировщика**

**Применяем схему резервирования N+1:**
- Для обработки трафика нужно 4 балансировщика
- Для отказоустойчивости добавляем 1 дополнительный
- **Итого необходимо L7-балансировщиков: 5**

Каждый балансировщик представляет собой виртуальную машину с 8-16 CPU, 16-32 ГБ ОЗУ и сетевым интерфейсом 10 Гбит/с.

### Источники
- SimilarWeb: https://www.similarweb.com/ru/website/afisha.yandex.ru/
- Данные экосистемы Яндекс (экстраполяция)
- Отраслевая статистика event-индустрии
